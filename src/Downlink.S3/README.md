Large portions of this code have been "borrowed" from the Foundatio project